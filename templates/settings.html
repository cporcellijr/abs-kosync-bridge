<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Settings - ABS-KoSync</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/jpeg" href="/static/icon.jpg">
    <link rel="apple-touch-icon" href="/static/icon.jpg">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            min-height: 100vh;
        }

        /* Nav Bar (Matches Index) */
        .top-nav {
            background: linear-gradient(180deg, rgba(20, 20, 20, 0.98) 0%, rgba(20, 20, 20, 0.95) 100%);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            padding: 20px 40px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .logo-section a {
            text-decoration: none;
        }

        .logo-section h1 {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .library-links {
            display: flex;
            align-items: center;
            gap: 12px;
            padding-left: 20px;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-icon-link {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 38px;
            height: 38px;
            border-radius: 10px;
            color: rgba(255, 255, 255, 0.6);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.03);
            text-decoration: none;
        }

        .nav-icon-link:hover {
            color: #ffffff;
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .nav-icon-link svg {
            width: 20px;
            height: 20px;
            stroke-width: 2;
        }

        .nav-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.05);
            color: #ccc;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .btn-primary {
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
            border-color: rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover {
            background: rgba(102, 126, 234, 0.3);
            border-color: rgba(102, 126, 234, 0.6);
        }

        .btn-danger {
            background: rgba(244, 67, 54, 0.1);
            border-color: rgba(244, 67, 54, 0.3);
            color: #e57373 !important;
        }

        .btn-danger:hover {
            background: rgba(244, 67, 54, 0.2);
            border-color: rgba(244, 67, 54, 0.5);
        }

        .cleanup-group {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-top: 5px;
        }

        .mt-20 {
            margin-top: 20px !important;
        }

        .flex-1 {
            flex: 1;
        }

        .m-0 {
            margin: 0 !important;
        }

        /* Container */
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px;
            padding-bottom: 100px;
        }

        /* Settings Form Structure */
        .settings-form {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .settings-section {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            overflow: hidden;
        }

        .section-header {
            padding: 20px;
            background: rgba(255, 255, 255, 0.02);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            /* No cursor pointer here anymore, controlled by switch if present */
            user-select: none;
        }

        .section-header h3 {
            font-size: 18px;
            color: #fff;
            margin: 0;
        }

        .section-body {
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            transition: all 0.3s ease;
        }

        .section-body.collapsed {
            display: none;
        }

        .hidden {
            display: none !important;
        }

        .full-width {
            grid-column: span 2;
        }

        /* Form Inputs */
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.6);
            font-weight: 600;
        }

        .form-group input,
        .form-group select {
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
            width: 100%;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .help-text {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.3);
            margin-top: -4px;
        }

        /* Custom Checkbox */
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.2);
            padding: 12px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
        }

        .checkbox-wrapper input {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .checkbox-wrapper label {
            margin: 0;
            cursor: pointer;
            color: #fff;
            font-size: 14px;
        }

        /* Toggle Switch */
        /* Hides the default checkbox but keeps it accessible/functional */
        .toggle-switch-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.1);
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: #ccc;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #667eea;
        }

        input:checked+.slider:before {
            transform: translateX(20px);
            background-color: #fff;
        }

        /* Flash Messages */
        .flash {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .flash-success {
            background: rgba(76, 175, 80, 0.1);
            border-color: rgba(76, 175, 80, 0.3);
            color: #81c784;
        }

        .flash-error {
            background: rgba(244, 67, 54, 0.1);
            border-color: rgba(244, 67, 54, 0.3);
            color: #e57373;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .section-body {
                grid-template-columns: 1fr;
            }

            .full-width {
                grid-column: span 1;
            }
        }

        .submit-bar {
            position: fixed;
            bottom: 20px;
            right: 20px;
            left: 20px;
            z-index: 90;
            max-width: 960px;
            margin: 0 auto;
            background: rgba(20, 20, 20, 0.9);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(102, 126, 234, 0.3);
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .restart-warn {
            color: #FF9800;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;

            .section-header-flat {
                background: none !important;
                border: none !important;
                padding-left: 0 !important;
                margin-bottom: 20px !important;
            }

            .section-header-flat h2 {
                font-size: 28px !important;
            }

            .section-highlight {
                border-color: rgba(102, 126, 234, 0.3) !important;
            }

            .text-primary {
                color: #667eea !important;
            }

            .toggle-label {
                font-size: 13px !important;
                color: rgba(255, 255, 255, 0.5) !important;
            }
        }
    </style>
</head>

<body>
    <div class="top-nav">
        <div class="logo-section">
            <a href="/" style="display: flex; align-items: center; gap: 12px; text-decoration: none;">
                <img src="/static/icon.jpg" alt="ABS-KoSync" class="app-icon"
                    style="height: 32px; width: 32px; border-radius: 6px;">
                <h1 style="font-size: 22px; margin: 0;">ABS-KoSync</h1>
            </a>

            <div class="library-links">
                {% if abs_server %}
                <a href="{{ abs_server }}" class="nav-icon-link" target="_blank" title="Audiobookshelf">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M11 5L6 9H2v6h4l5 4V5z"></path>
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                    </svg>
                </a>
                {% endif %}

                {% if booklore_server %}
                <a href="{{ booklore_server }}" class="nav-icon-link" target="_blank" title="Ebook Library">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                    </svg>
                </a>
                {% endif %}

                {% if shelfmark_url and get_bool('SHELFMARK_ENABLED') %}
                <a href="/shelfmark" class="nav-icon-link" title="Shelfmark Tool">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                        <line x1="7" y1="7" x2="7.01" y2="7"></line>
                    </svg>
                </a>
                {% endif %}
            </div>
        </div>

        <div class="nav-actions">
            <a href="https://cporcellijr.github.io/abs-kosync-bridge/" class="btn" target="_blank"
                rel="noopener noreferrer">üìö Docs</a>
            <a href="/" class="btn">‚Üê Dashboard</a>
            <a href="/logs" class="btn">üìä Logs</a>
            <a href="/forge" class="btn">‚ö° Forge</a>
        </div>
    </div>

    <div class="container">
        {% if message %}
        <div class="flash {% if is_error %}flash-error{% else %}flash-success{% endif %}">
            {{ message }}
        </div>
        {% endif %}

        <div class="section-header-flat">
            <h2>‚öôÔ∏è Application Settings</h2>
        </div>

        <form method="POST" action="/settings" class="settings-form" id="settingsForm">

            <div class="settings-section">
                <div class="section-header">
                    <h3>General Settings</h3>
                </div>
                <div class="section-body">
                    <div class="form-group">
                        <label>Timezone</label>
                        <input type="text" name="TZ" value="{{ get_val('TZ') }}">
                    </div>
                    <div class="form-group">
                        <label>Log Level</label>
                        <select name="LOG_LEVEL">
                            {% for level in ['DEBUG', 'INFO', 'WARNING', 'ERROR', 'CRITICAL'] %}
                            <option value="{{ level }}" {% if get_val('LOG_LEVEL')==level %}selected{% endif %}>{{ level
                                }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <div class="settings-section section-highlight">
                <div class="section-header">
                    <h3 class="text-primary">Audiobookshelf (Required)</h3>
                </div>
                <div class="section-body">
                    <!-- Moved Checkbox to top -->
                    <div class="checkbox-wrapper full-width">
                        <input type="checkbox" id="abs_only_lib" name="ABS_ONLY_SEARCH_IN_ABS_LIBRARY_ID" {% if
                            get_bool('ABS_ONLY_SEARCH_IN_ABS_LIBRARY_ID') %}checked{% endif %}>
                        <label for="abs_only_lib">Limit Search to Configured Library</label>
                    </div>

                    <div class="form-group full-width">
                        <label>Server URL</label>
                        <input type="text" name="ABS_SERVER" value="{{ get_val('ABS_SERVER') }}" required>
                    </div>
                    <div class="form-group full-width">
                        <label>API Token</label>
                        <input type="password" name="ABS_KEY" value="{{ get_val('ABS_KEY') }}" required>
                    </div>

                    <!-- Wrapper for Library ID -->
                    <div id="abs_library_id_group" class="form-group">
                        <label>Library ID</label>
                        <input type="text" name="ABS_LIBRARY_ID" value="{{ get_val('ABS_LIBRARY_ID') }}" required>
                    </div>

                    <div class="form-group">
                        <label>Collection Name (Auto-Add)</label>
                        <input type="text" name="ABS_COLLECTION_NAME" value="{{ get_val('ABS_COLLECTION_NAME') }}">
                    </div>
                    <div class="form-group">
                        <label>Progress Offset (Seconds)</label>
                        <input type="number" name="ABS_PROGRESS_OFFSET_SECONDS"
                            value="{{ get_val('ABS_PROGRESS_OFFSET_SECONDS') }}">
                        <div class="help-text">Rewind progress sent to ABS (e.g. -60)</div>
                    </div>
                    <!-- Old Checkbox location removed -->
                </div>
            </div>

            <!-- KOSync Server (Optional) -->
            <div class="settings-section section-highlight" style="border-color: rgba(102, 126, 234, 0.3);">
                {% set kosync_configured = get_val('KOSYNC_SERVER') != '' %}
                {% set kosync_enabled = get_bool('KOSYNC_ENABLED') or (kosync_configured and get_val('KOSYNC_ENABLED')
                == '') %}
                <div class="section-header">
                    <h3 class="text-primary">KOSync Integration</h3>
                    <div class="toggle-switch-wrapper">
                        <span class="toggle-label">Enable</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggle_kosync" name="KOSYNC_ENABLED"
                                onchange="toggleSection('kosync_body', this.checked)" {% if kosync_enabled %}checked{%
                                endif %}>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div id="kosync_body" class="section-body {% if not kosync_enabled %}collapsed{% endif %}">

                    <!-- Integrated Server Toggle -->
                    <div class="checkbox-wrapper full-width">
                        <!-- We use a hidden input or similar logic? 
                             The user wants a toggle "Use Built-in KOSync Bridge"
                             Let's assume a new setting key KOSYNC_USE_BUILTIN for the frontend logic, 
                             or strictly rely on front-end JS to set the URL.
                             The request says: "secondary toggle one for yes use kosync which opens url to input user/pass... then the second to use built in"
                        -->
                        <input type="checkbox" id="kosync_use_builtin" onchange="toggleKosyncServerMode()" checked>
                        <label for="kosync_use_builtin">Use Built-in KOSync Bridge (Recommended)</label>
                    </div>

                    <!-- Public URL (Only if Built-in) -->
                    <div id="kosync_public_url_group" class="full-width"
                        style="background: rgba(102, 126, 234, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(102, 126, 234, 0.2); margin-bottom: 5px;">
                        <h4 style="margin-bottom: 12px; color: #fff; font-size: 14px;">üöÄ Public URL (Put this in
                            KOReader)</h4>

                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="public_kosync_url" aria-label="Public KOSync URL" value=""
                                onclick="this.select()"
                                style="flex: 1; cursor: text; font-family: monospace; color: #667eea; font-weight: bold; background: rgba(0,0,0,0.2);">
                            <button type="button" class="btn" onclick="copyPublicUrl()"
                                title="Copy to clipboard">üìã</button>
                        </div>
                        <div class="help-text" style="color: rgba(255,255,255,0.5); margin-top: 4px;">Replace
                            'localhost' with your server IP or Domain if accessing remotely.</div>
                    </div>

                    <div class="form-group full-width">
                        <label>Target KOSync URL</label>
                        <input type="text" name="KOSYNC_SERVER" id="kosync_server_input"
                            value="{{ get_val('KOSYNC_SERVER') }}">
                        <div class="help-text" id="kosync_server_help">Internal URL the bridge connects to.</div>
                    </div>

                    <!-- Separator -->
                    <div class="full-width" style="margin: 10px 0; border-top: 1px solid rgba(255,255,255,0.1);"></div>
                    <h4 class="full-width" style="font-size: 14px; color: #fff; margin-bottom: -10px;">User Credentials
                    </h4>

                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" name="KOSYNC_USER" value="{{ get_val('KOSYNC_USER') }}">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" name="KOSYNC_KEY" value="{{ get_val('KOSYNC_KEY') }}">
                        <div class="help-text">This will be your KOSync password in KOReader.</div>
                    </div>
                    <div class="form-group full-width">
                        <label>Hash Method</label>
                        <select name="KOSYNC_HASH_METHOD">
                            <option value="content" {% if get_val('KOSYNC_HASH_METHOD')=='content' %}selected{% endif
                                %}>Content (Slower/Accurate)</option>
                            <option value="filename" {% if get_val('KOSYNC_HASH_METHOD')=='filename' %}selected{% endif
                                %}>Filename (Fast)</option>
                        </select>
                    </div>
                    <div class="checkbox-wrapper full-width">
                        <input type="checkbox" id="kosync_pct" name="KOSYNC_USE_PERCENTAGE_FROM_SERVER" {% if
                            get_bool('KOSYNC_USE_PERCENTAGE_FROM_SERVER') %}checked{% endif %}>
                        <label for="kosync_pct">Use Percentage from Server (Ignore Text Matching)</label>
                    </div>
                </div>
            </div>

            <!-- Storyteller (Optional) -->
            <div class="settings-section">
                {% set storyteller_configured = get_val('STORYTELLER_API_URL') != '' %}
                {% set storyteller_enabled = get_bool('STORYTELLER_ENABLED') or (storyteller_configured and
                get_val('STORYTELLER_ENABLED') == '') %}
                <div class="section-header">
                    <h3>Storyteller</h3>
                    <div class="toggle-switch-wrapper">
                        <span class="toggle-label">Enable</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggle_storyteller" name="STORYTELLER_ENABLED"
                                onchange="toggleSection('storyteller_body', this.checked)" {% if storyteller_enabled
                                %}checked{% endif %}>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div id="storyteller_body" class="section-body {% if not storyteller_enabled %}collapsed{% endif %}">
                    <div class="form-group full-width">
                        <label>API URL</label>
                        <input type="text" name="STORYTELLER_API_URL" value="{{ get_val('STORYTELLER_API_URL') }}">
                    </div>
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" name="STORYTELLER_USER" value="{{ get_val('STORYTELLER_USER') }}">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" name="STORYTELLER_PASSWORD"
                            value="{{ get_val('STORYTELLER_PASSWORD') }}">
                    </div>
                </div>
            </div>

            <!-- Booklore (Optional) -->
            <div class="settings-section">
                {% set booklore_configured = get_val('BOOKLORE_SERVER') != '' %}
                {% set booklore_enabled = get_bool('BOOKLORE_ENABLED') or (booklore_configured and
                get_val('BOOKLORE_ENABLED') == '') %}
                <div class="section-header">
                    <h3>Booklore</h3>
                    <div class="toggle-switch-wrapper">
                        <span class="toggle-label">Enable</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggle_booklore" name="BOOKLORE_ENABLED"
                                onchange="toggleSection('booklore_body', this.checked)" {% if booklore_enabled
                                %}checked{% endif %}>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div id="booklore_body" class="section-body {% if not booklore_enabled %}collapsed{% endif %}">
                    <div class="form-group full-width">
                        <label>Server URL</label>
                        <input type="text" name="BOOKLORE_SERVER" value="{{ get_val('BOOKLORE_SERVER') }}">
                    </div>
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" name="BOOKLORE_USER" value="{{ get_val('BOOKLORE_USER') }}">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" name="BOOKLORE_PASSWORD" value="{{ get_val('BOOKLORE_PASSWORD') }}">
                    </div>
                    <div class="form-group">
                        <label>Shelf Name</label>
                        <input type="text" name="BOOKLORE_SHELF_NAME" value="{{ get_val('BOOKLORE_SHELF_NAME') }}">
                    </div>
                    <div class="form-group full-width">
                        <label>Booklore Library ID (Optional)</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" name="BOOKLORE_LIBRARY_ID" value="{{ get_val('BOOKLORE_LIBRARY_ID') }}"
                                placeholder="e.g. 1" style="flex: 1;">
                            <button class="btn" type="button" onclick="checkBookloreLibs()">üîç Find IDs</button>
                        </div>
                        <div class="help-text">Restricts sync to a specific library (e.g., 1). Leave empty to sync all.
                        </div>
                    </div>
                </div>
            </div>


            <!-- CWA (Optional) -->
            <div class="settings-section">
                {% set cwa_configured = get_val('CWA_SERVER') != '' %}
                {% set cwa_enabled = get_bool('CWA_ENABLED') %}
                <div class="section-header">
                    <h3>Calibre-Web Automated</h3>
                    <div class="toggle-switch-wrapper">
                        <span class="toggle-label">Enable</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggle_cwa" name="CWA_ENABLED"
                                onchange="toggleSection('cwa_body', this.checked)" {% if cwa_enabled %}checked{% endif
                                %}>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div id="cwa_body" class="section-body {% if not cwa_enabled %}collapsed{% endif %}">
                    <div class="form-group full-width">
                        <label>Server URL</label>
                        <input type="text" name="CWA_SERVER" value="{{ get_val('CWA_SERVER') }}">
                        <div class="help-text">URL to your Calibre-Web Automated instance (e.g.
                            http://192.168.1.100:8083)</div>
                    </div>
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" name="CWA_USERNAME" value="{{ get_val('CWA_USERNAME') }}">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" name="CWA_PASSWORD" value="{{ get_val('CWA_PASSWORD') }}">
                    </div>
                </div>
            </div>

            <!-- Hardcover.app (Optional) -->
            <div class="settings-section">
                {% set hardcover_configured = get_val('HARDCOVER_TOKEN') != '' %}
                {% set hardcover_enabled = get_bool('HARDCOVER_ENABLED') or (hardcover_configured and
                get_val('HARDCOVER_ENABLED') == '') %}
                <div class="section-header">
                    <h3>Hardcover.app</h3>
                    <div class="toggle-switch-wrapper">
                        <span class="toggle-label">Enable</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggle_hardcover" name="HARDCOVER_ENABLED"
                                onchange="toggleSection('hardcover_body', this.checked)" {% if hardcover_enabled
                                %}checked{% endif %}>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div id="hardcover_body" class="section-body {% if not hardcover_enabled %}collapsed{% endif %}">
                    <div class="form-group full-width">
                        <label>API Token</label>
                        <input type="password" name="HARDCOVER_TOKEN" value="{{ get_val('HARDCOVER_TOKEN') }}">
                    </div>
                </div>
            </div>

            <!-- Telegram (Optional) -->
            <div class="settings-section">
                {% set telegram_configured = get_val('TELEGRAM_BOT_TOKEN') != '' %}
                {% set telegram_enabled = get_bool('TELEGRAM_ENABLED') or (telegram_configured and
                get_val('TELEGRAM_ENABLED') == '') %}
                <div class="section-header">
                    <h3>Telegram Notifications</h3>
                    <div class="toggle-switch-wrapper">
                        <span class="toggle-label">Enable</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggle_telegram" name="TELEGRAM_ENABLED"
                                onchange="toggleSection('telegram_body', this.checked)" {% if telegram_enabled
                                %}checked{% endif %}>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div id="telegram_body" class="section-body {% if not telegram_enabled %}collapsed{% endif %}">
                    <div class="form-group full-width">
                        <label>Bot Token</label>
                        <input type="password" name="TELEGRAM_BOT_TOKEN" value="{{ get_val('TELEGRAM_BOT_TOKEN') }}">
                    </div>
                    <div class="form-group">
                        <label>Chat ID</label>
                        <input type="text" name="TELEGRAM_CHAT_ID" value="{{ get_val('TELEGRAM_CHAT_ID') }}">
                    </div>
                    <div class="form-group">
                        <label>Min Log Level</label>
                        <select name="TELEGRAM_LOG_LEVEL">
                            {% for level in ['DEBUG', 'INFO', 'WARNING', 'ERROR', 'CRITICAL'] %}
                            <option value="{{ level }}" {% if get_val('TELEGRAM_LOG_LEVEL', 'ERROR' )==level
                                %}selected{% endif %}>{{ level }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <!-- Shelfmark (Optional) -->
            <div class="settings-section">
                <div class="section-header">
                    <h3>Shelfmark View</h3>
                    <div class="toggle-switch-wrapper">
                        <span class="toggle-label">Enable</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggle_shelfmark" aria-label="Enable Shelfmark"
                                name="SHELFMARK_ENABLED" {% if get_bool('SHELFMARK_ENABLED') or
                                (get_val('SHELFMARK_URL') !='' and get_val('SHELFMARK_ENABLED')=='' ) %}checked{% endif
                                %}>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="section-body">
                    <div class="form-group full-width">
                        <label>Shelfmark URL</label>
                        <input type="text" name="SHELFMARK_URL" value="{{ get_val('SHELFMARK_URL') }}">
                        <div class="help-text">URL to display in the Shelfmark tab (e.g. your Shelfmark instance URL)
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <div class="section-header">
                    <h3>Suggestions</h3>
                    <div class="toggle-switch-wrapper">
                        <span class="toggle-label">Enable</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggle_suggestions" name="SUGGESTIONS_ENABLED" {% if
                                get_bool('SUGGESTIONS_ENABLED') %}checked{% endif %}>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="section-body">
                    <div class="full-width">
                        <p class="help-text">
                            When enabled, the system will look for unmapped audiobooks with progress and suggest
                            matching ebooks from your library.
                        </p>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <div class="section-header">
                    <h3>Sync Behavior</h3>
                </div>
                <div class="section-body">
                    <div class="form-group">
                        <label>Sync Period (Minutes)</label>
                        <input type="number" name="SYNC_PERIOD_MINS" value="{{ get_val('SYNC_PERIOD_MINS') }}">
                    </div>
                    <div class="form-group">
                        <label>Min ABS Change (Seconds)</label>
                        <input type="number" name="SYNC_DELTA_ABS_SECONDS"
                            value="{{ get_val('SYNC_DELTA_ABS_SECONDS') }}">
                    </div>
                    <div class="form-group">
                        <label>Min Ebook Change (%)</label>
                        <input type="number" step="0.1" name="SYNC_DELTA_KOSYNC_PERCENT"
                            value="{{ get_val('SYNC_DELTA_KOSYNC_PERCENT') }}">
                    </div>
                    <div class="form-group">
                        <label>Client Diff Threshold (%)</label>
                        <input type="number" step="0.1" name="SYNC_DELTA_BETWEEN_CLIENTS_PERCENT"
                            value="{{ get_val('SYNC_DELTA_BETWEEN_CLIENTS_PERCENT') }}">
                    </div>
                    <div class="checkbox-wrapper full-width">
                        <input type="checkbox" id="xpath_fallback" name="XPATH_FALLBACK_TO_PREVIOUS_SEGMENT" {% if
                            get_bool('XPATH_FALLBACK_TO_PREVIOUS_SEGMENT') %}checked{% endif %}>
                        <label for="xpath_fallback">XPath Fallback (Try previous segment if match fails)</label>
                    </div>
                    <div class="checkbox-wrapper full-width">
                        <input type="checkbox" id="abs_ebook" name="SYNC_ABS_EBOOK" {% if get_bool('SYNC_ABS_EBOOK')
                            %}checked{% endif %}>
                        <label for="abs_ebook">Enable ABS Ebook Sync (Bi-directional)</label>
                    </div>
                    <div class="checkbox-wrapper full-width">
                        <input type="checkbox" id="reprocess_on_clear" name="REPROCESS_ON_CLEAR_IF_NO_ALIGNMENT" {% if
                            get_bool('REPROCESS_ON_CLEAR_IF_NO_ALIGNMENT') %}checked{% endif %}>
                        <label for="reprocess_on_clear">Regenerate Missing Data on Reset</label>
                        <div class="help-text" style="display: block; width: 100%; margin-top: 5px;">
                            When resetting your progress, check for missing sync data. If found, the system will attempt
                            to regenerate it (which may require re-transcription).
                        </div>
                    </div>

                    <!-- Instant Sync -->
                    <div class="subsection-header" style="width: 100%; margin-top: 20px; margin-bottom: 8px; padding-bottom: 6px; border-bottom: 1px solid var(--border-color, #ddd);">
                        <h4 style="margin: 0; font-size: 0.95rem; font-weight: 600;">Instant Sync</h4>
                    </div>
                    <div class="checkbox-wrapper full-width">
                        <input type="checkbox" id="instant_sync_enabled" name="INSTANT_SYNC_ENABLED" {% if
                            get_bool('INSTANT_SYNC_ENABLED') %}checked{% endif %}>
                        <label for="instant_sync_enabled">Enable Instant Sync</label>
                        <div class="help-text" style="display: block; width: 100%; margin-top: 5px;">
                            Triggers immediate sync when progress changes in ABS (via Socket.IO) or KOReader (via KoSync).
                            Disable to rely solely on polling.
                        </div>
                    </div>

                    <!-- Per-Client Polling -->
                    <div class="subsection-header" style="width: 100%; margin-top: 20px; margin-bottom: 8px; padding-bottom: 6px; border-bottom: 1px solid var(--border-color, #ddd);">
                        <h4 style="margin: 0; font-size: 0.95rem; font-weight: 600;">Per-Client Polling</h4>
                        <p class="help-text" style="margin: 6px 0 0 0;">
                            Configure how often each client is checked for progress changes.
                            <em>Global</em> uses the global sync interval above.
                            <em>Custom</em> lets you set a faster interval for that client.
                        </p>
                    </div>

                    {% if get_bool('STORYTELLER_ENABLED') %}
                    <div class="form-group" style="align-items: center;">
                        <label>Storyteller Poll Mode</label>
                        <select name="STORYTELLER_POLL_MODE" id="storyteller_poll_mode"
                                onchange="togglePollSeconds('storyteller_poll_seconds_row', this.value)">
                            <option value="global" {% if get_val('STORYTELLER_POLL_MODE', 'global') == 'global' %}selected{% endif %}>Global</option>
                            <option value="custom" {% if get_val('STORYTELLER_POLL_MODE') == 'custom' %}selected{% endif %}>Custom</option>
                        </select>
                    </div>
                    <div class="form-group" id="storyteller_poll_seconds_row"
                         {% if get_val('STORYTELLER_POLL_MODE') != 'custom' %}style="opacity: 0.45; pointer-events: none;"{% endif %}>
                        <label>Storyteller Poll Interval (seconds)</label>
                        <input type="number" name="STORYTELLER_POLL_SECONDS" min="10"
                               value="{{ get_val('STORYTELLER_POLL_SECONDS', '45') }}">
                        <div class="help-text">Recommended: 30‚Äì60s for Storyteller (active reading source).</div>
                    </div>
                    {% endif %}

                    {% if get_bool('BOOKLORE_ENABLED') %}
                    <div class="form-group" style="align-items: center;">
                        <label>Booklore Poll Mode</label>
                        <select name="BOOKLORE_POLL_MODE" id="booklore_poll_mode"
                                onchange="togglePollSeconds('booklore_poll_seconds_row', this.value)">
                            <option value="global" {% if get_val('BOOKLORE_POLL_MODE', 'global') == 'global' %}selected{% endif %}>Global</option>
                            <option value="custom" {% if get_val('BOOKLORE_POLL_MODE') == 'custom' %}selected{% endif %}>Custom</option>
                        </select>
                    </div>
                    <div class="form-group" id="booklore_poll_seconds_row"
                         {% if get_val('BOOKLORE_POLL_MODE') != 'custom' %}style="opacity: 0.45; pointer-events: none;"{% endif %}>
                        <label>Booklore Poll Interval (seconds)</label>
                        <input type="number" name="BOOKLORE_POLL_SECONDS" min="10"
                               value="{{ get_val('BOOKLORE_POLL_SECONDS', '300') }}">
                        <div class="help-text">Recommended: 300s for Booklore.</div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- System Paths -->
            <div class="settings-section">
                <div class="section-header">
                    <h3>System Paths</h3>
                </div>
                <div class="section-body">
                    <div class="form-group">
                        <label>Data Directory</label>
                        <input type="text" name="DATA_DIR" value="{{ get_val('DATA_DIR') }}">
                    </div>
                    <div class="form-group">
                        <label>Books Directory</label>
                        <input type="text" name="BOOKS_DIR" value="{{ get_val('BOOKS_DIR') }}">
                    </div>
                    <div class="form-group">
                        <label>Storyteller Library Path</label>
                        <input type="text" name="STORYTELLER_LIBRARY_DIR"
                            value="{{ get_val('STORYTELLER_LIBRARY_DIR') }}"
                            placeholder="Where Storyteller scans for books">
                        <div class="help-text">Target directory where Forge writes files for Storyteller to process.
                        </div>
                    </div>


                    <div class="form-group">
                        <label>Audiobooks Dir</label>
                        <input type="text" name="AUDIOBOOKS_DIR" value="{{ get_val('AUDIOBOOKS_DIR') }}">
                    </div>
                </div>
            </div>

            <!-- Advanced -->
            <div class="settings-section">
                <div class="section-header">
                    <h3>Advanced Options</h3>
                </div>
                <div class="section-body">
                    <!-- System Settings (Moved to Top) -->

                    <div class="form-group">
                        <label>Job Max Retries</label>
                        <input type="number" name="JOB_MAX_RETRIES" value="{{ get_val('JOB_MAX_RETRIES') }}">
                    </div>
                    <div class="form-group">
                        <label>Job Retry Delay (Mins)</label>
                        <input type="number" name="JOB_RETRY_DELAY_MINS" value="{{ get_val('JOB_RETRY_DELAY_MINS') }}">
                    </div>

                    <div class="form-group">
                        <label>Fuzzy Match Threshold</label>
                        <input type="number" step="0.1" name="FUZZY_MATCH_THRESHOLD"
                            value="{{ get_val('FUZZY_MATCH_THRESHOLD') }}">
                    </div>
                    <div class="form-group">
                        <label>SMIL Validation Threshold (%)</label>
                        <input type="number" step="1" min="0" max="100" name="SMIL_VALIDATION_THRESHOLD"
                            value="{{ get_val('SMIL_VALIDATION_THRESHOLD', '60') }}">
                        <div class="help-text">Minimum token match % to accept EPUB SMIL data. Lower = more lenient.
                        </div>
                    </div>

                    <div class="form-group full-width mt-20">
                        <label>Suggestion Cleanup</label>
                        <div class="cleanup-group">
                            <button type="button" class="btn btn-danger" onclick="clearStaleSuggestions()">
                                üßπ Clear Stale Suggestions
                            </button>
                            <p class="help-text flex-1 m-0">
                                Deletes all suggestions for books that are not currently in your bridge library.
                                This helps clear out junk suggestions and allows the bridge to re-suggest them if
                                needed.
                            </p>
                        </div>
                    </div>

                    <hr style="margin: 20px 0; border-color: var(--border-color); opacity: 0.3; grid-column: span 2;">

                    <!-- Transcription Settings -->
                    <div class="form-group">
                        <label>Transcription Provider</label>
                        <select name="TRANSCRIPTION_PROVIDER">
                            <option value="local" {% if get_val('TRANSCRIPTION_PROVIDER')=='local' %}selected{% endif
                                %}>
                                Local Whisper
                            </option>

                            <option value="deepgram" {% if get_val('TRANSCRIPTION_PROVIDER')=='deepgram' %}selected{%
                                endif %}>
                                Deepgram (Cloud)
                            </option>

                            <option value="whispercpp" {% if get_val('TRANSCRIPTION_PROVIDER')=='whispercpp'
                                %}selected{% endif %}>
                                Whisper.cpp (Server)
                            </option>
                        </select>

                        <div class="help-text">
                            Local = faster‚Äëwhisper. Deepgram = cloud. Whisper.cpp = external HTTP server.
                        </div>
                    </div>
                    <!-- Wrapper: Whisper.cpp -->
                    <div id="group_whispercpp" class="dynamic-group full-width" style="display:contents;">
                        <div class="form-group full-width">
                            <label>Whisper.cpp Server URL</label>
                            <input type="text" name="WHISPER_CPP_URL" value="{{ get_val('WHISPER_CPP_URL', '') }}"
                                placeholder="http://192.168.178.132:11080/audio/transcriptions" />
                            <div class="help-text">Example: http://HOST:11080/audio/transcriptions</div>
                        </div>
                    </div>

                    <!-- Wrapper: Deepgram -->
                    <div id="group_deepgram" class="dynamic-group full-width" style="display:contents;">
                        <div class="form-group">
                            <label>Deepgram API Key</label>
                            <input type="password" name="DEEPGRAM_API_KEY" value="{{ get_val('DEEPGRAM_API_KEY') }}"
                                placeholder="dg_...">
                            <div class="help-text">Get your key at <a href="https://console.deepgram.com"
                                    target="_blank" rel="noopener noreferrer">console.deepgram.com</a></div>
                        </div>
                        <div class="form-group">
                            <label for="deepgram_model">Deepgram Model</label>
                            <select name="DEEPGRAM_MODEL" id="deepgram_model">
                                <option value="nova-2" {% if get_val('DEEPGRAM_MODEL')=='nova-2' %}selected{% endif %}>
                                    Nova-2 (Best accuracy)</option>
                                <option value="nova-3" {% if get_val('DEEPGRAM_MODEL')=='nova-3' %}selected{% endif %}>
                                    Nova-3 (Latest)</option>
                                <option value="base" {% if get_val('DEEPGRAM_MODEL')=='base' %}selected{% endif %}>Base
                                    (Fastest)</option>
                                <option value="enhanced" {% if get_val('DEEPGRAM_MODEL')=='enhanced' %}selected{% endif
                                    %}>
                                    Enhanced</option>
                            </select>
                            <div class="help-text">Nova-2 recommended. See <a
                                    href="https://developers.deepgram.com/docs/models" target="_blank"
                                    rel="noopener noreferrer">Deepgram
                                    Models</a>
                            </div>
                            <div class="alert alert-warning" id="gpu_warning" style="display:none; margin-top:10px;">
                                <strong>‚ö†Ô∏è NVIDIA GPU Selected:</strong>
                                <ul style="margin: 5px 0 0 20px; font-size: 0.9em;">
                                    <li>Ensure <code>INSTALL_GPU: "true"</code> is set in docker-compose.yml (this
                                        builds the container with CUDA libraries).</li>
                                    <li>Ensure the <strong>NVIDIA Container Toolkit</strong> is installed on your host
                                        system (this allows Docker to access your GPU).</li>
                                </ul>
                            </div>
                        </div>
                    </div>


                    <!-- Wrapper: Whisper Model (shared by Local + Whisper.cpp Server) -->
                    <div id="group_whisper_model" class="dynamic-group full-width" style="display:contents;">
                        <div class="form-group">
                            <label>Whisper Model</label>
                            <select name="WHISPER_MODEL">
                                {% for model in ['tiny', 'base', 'small', 'medium', 'large-v2', 'large-v3'] %}
                                <option value="{{ model }}" {% if get_val('WHISPER_MODEL')==model %}selected{% endif %}>
                                    {{ model }}</option>
                                {% endfor %}
                            </select>
                            <div class="help-text">Model size for Local Whisper and Whisper.cpp Server. Larger =
                                better accuracy but slower.
                            </div>
                        </div>
                    </div>

                    <!-- Wrapper: Local Whisper (device + compute only) -->
                    <div id="group_local" class="dynamic-group full-width" style="display:contents;">
                        <div class="form-group">
                            <label>Whisper Device</label>
                            <select name="WHISPER_DEVICE">
                                <option value="cpu" {% if get_val('WHISPER_DEVICE')=='cpu' %}selected{% endif %}>CPU
                                </option>
                                <option value="cuda" {% if get_val('WHISPER_DEVICE')=='cuda' %}selected{% endif %}>GPU
                                    (NVIDIA)
                                </option>
                            </select>
                            <div class="help-text">Use CUDA for NVIDIA GPU. Default is CPU.</div>
                        </div>
                        <div class="form-group">
                            <label>Whisper Compute Type</label>
                            <select name="WHISPER_COMPUTE_TYPE">
                                <option value="auto" {% if get_val('WHISPER_COMPUTE_TYPE')=='auto' %}selected{% endif
                                    %}>
                                    Auto (int8 CPU / float16 GPU)</option>
                                <option value="int8" {% if get_val('WHISPER_COMPUTE_TYPE')=='int8' %}selected{% endif
                                    %}>
                                    int8 (Fast, CPU-optimized)</option>
                                <option value="float16" {% if get_val('WHISPER_COMPUTE_TYPE')=='float16' %}selected{%
                                    endif %}>
                                    float16 (Fast, GPU-optimized)</option>
                                <option value="float32" {% if get_val('WHISPER_COMPUTE_TYPE')=='float32' %}selected{%
                                    endif %}>
                                    float32 (Highest accuracy)</option>
                            </select>
                            <div class="help-text">Use int8 for CPU, float16 for GPU.</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="submit-bar">
                <span class="restart-warn">‚ö†Ô∏è Application will restart instantly</span>
                <button type="submit" class="btn btn-primary">üíæ Save Settings</button>
            </div>
        </form>
    </div>

    <script>
        function checkBookloreLibs() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚åõ Scanning...';
            btn.disabled = true;

            fetch('/api/booklore/libraries')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Error: ' + data.error);
                        return;
                    }
                    if (data.length === 0) {
                        alert('No libraries found. Check connection or try syncing first.');
                        return;
                    }

                    let msg = "Found Libraries:\n\n";
                    data.forEach(lib => {
                        msg += `üÜî ID: ${lib.id}\nüìÅ Name: ${lib.name}\n------------------\n`;
                    });
                    alert(msg);
                })
                .catch(err => alert('Failed to fetch libraries: ' + err))
                .finally(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
        }

        function toggleSection(bodyId, isChecked) {
            const body = document.getElementById(bodyId);
            if (isChecked) {
                body.classList.remove('collapsed');
            } else {
                body.classList.add('collapsed');
                // Optional: Clear inputs when disabling?
                // For now, we prefer keeping values in UI so user doesn't lose config by accidental toggle
            }
        }

        function togglePollSeconds(rowId, mode) {
            const row = document.getElementById(rowId);
            if (!row) return;
            if (mode === 'custom') {
                row.style.opacity = '';
                row.style.pointerEvents = '';
            } else {
                row.style.opacity = '0.45';
                row.style.pointerEvents = 'none';
            }
        }

        function toggleKosyncServerMode() {
            const useBuiltin = document.getElementById('kosync_use_builtin').checked;

            const internalInput = document.getElementById('kosync_server_input');
            const publicGroup = document.getElementById('kosync_public_url_group');
            // We want to force it if checked?

            if (useBuiltin) {
                // Show Public URL section
                if (publicGroup) publicGroup.classList.remove('hidden');

                // Force internal value and make readonly
                internalInput.value = "http://127.0.0.1:{{ get_val('KOSYNC_PORT', '5757') }}";
                internalInput.setAttribute('readonly', 'readonly');
                internalInput.style.opacity = "0.7";
                internalInput.style.cursor = "not-allowed";
            } else {
                // Hide Public URL section
                if (publicGroup) publicGroup.classList.add('hidden');

                // Make internal editable (user must set external server)
                // We don't necessarily clear it, but maybe we should? 
                // Let's leave it, user can edit.
                internalInput.removeAttribute('readonly');
                internalInput.style.opacity = "1";
                internalInput.style.cursor = "text";
                // If it was the localhost default, maybe clear it? No, safe to leave.
            }
        }

        function copyPublicUrl() {
            const copyText = document.getElementById("public_kosync_url");
            copyText.select();
            copyText.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(copyText.value);
            // Visual feedback
            const originalBg = copyText.style.backgroundColor;
            copyText.style.backgroundColor = "rgba(102, 126, 234, 0.3)";
            setTimeout(() => copyText.style.backgroundColor = originalBg, 200);
        }

        async function clearStaleSuggestions() {
            if (!confirm("Are you sure you want to clear stale suggestions?\n\nThis will permanently delete all suggestions for books that are not currently matched in your bridge. Books you are already syncing will be preserved.")) {
                return;
            }

            try {
                const response = await fetch('/api/suggestions/clear_stale', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                if (data.success) {
                    alert(`‚úÖ Success! Cleared ${data.count} stale suggestions.`);
                } else {
                    alert(`‚ùå Failed to clear suggestions: ${data.error || 'Unknown error'}`);
                }
            } catch (err) {
                console.error('Error clearing suggestions:', err);
                alert('‚ùå An error occurred while clearing suggestions. Check console for details.');
            }
        }

        // Auto-calculate public URL on load
        document.addEventListener('DOMContentLoaded', function () {
            const configuredPort = "{{ get_val('KOSYNC_PORT', '5757') }}";

            // Simple generic suggestion as requested
            let suggestedUrl = `http://localhost:${configuredPort}`;

            const publicUrlInput = document.getElementById('public_kosync_url');
            publicUrlInput.value = suggestedUrl;

            // Make it editable
            publicUrlInput.removeAttribute('readonly');
            publicUrlInput.style.backgroundColor = "rgba(0,0,0,0.2)";
            publicUrlInput.style.cursor = "text";

            // Initialize Dynamic Logic
            initDynamicForms();

            // Check initial state of KOSync
            const kosyncServerVal = document.getElementById('kosync_server_input').value;
            // If it matches localhost, check the box. Else uncheck.
            const builtinCheckbox = document.getElementById('kosync_use_builtin');
            if (kosyncServerVal === "http://127.0.0.1:{{ get_val('KOSYNC_PORT', '5757') }}" || kosyncServerVal === "") {
                builtinCheckbox.checked = true;
            } else {
                builtinCheckbox.checked = false;
            }
            toggleKosyncServerMode();
        });

        function initDynamicForms() {
            // 1. ABS Library ID Toggle
            const absCheckbox = document.getElementById('abs_only_lib');
            if (absCheckbox) {
                absCheckbox.addEventListener('change', toggleAbsLibraryId);
                toggleAbsLibraryId(); // Initial state
            }

            // 2. Transcription Provider Toggle
            const providerSelect = document.querySelector('select[name="TRANSCRIPTION_PROVIDER"]');
            if (providerSelect) {
                providerSelect.addEventListener('change', toggleProviderSettings);
                toggleProviderSettings(); // Initial state
            }

            // 3. GPU Warning
            const deviceSelect = document.querySelector('select[name="WHISPER_DEVICE"]');
            if (deviceSelect) {
                deviceSelect.addEventListener('change', function () {
                    if (this.value === 'cuda') {
                        alert("To use an NVIDIA GPU, you must modify your docker-compose.yml to include the 'deploy' block with 'capabilities: [gpu]' and ensure the NVIDIA Container Toolkit is installed on your host.");
                    }
                });
            }
        }

        function toggleAbsLibraryId() {
            const checkbox = document.getElementById('abs_only_lib');
            const group = document.getElementById('abs_library_id_group');
            const input = document.querySelector('input[name="ABS_LIBRARY_ID"]');

            if (checkbox && group && input) {
                if (checkbox.checked) {
                    group.classList.remove('hidden');
                    input.setAttribute('required', 'required');
                } else {
                    group.classList.add('hidden');
                    input.removeAttribute('required');
                }
            }
        }

        function toggleProviderSettings() {
            const provider = document.querySelector('select[name="TRANSCRIPTION_PROVIDER"]').value;

            // Groups
            const groupLocal = document.getElementById('group_local');
            const groupDeepgram = document.getElementById('group_deepgram');
            const groupWhisperCpp = document.getElementById('group_whispercpp');
            const groupWhisperModel = document.getElementById('group_whisper_model');

            // Hide all first
            if (groupLocal) groupLocal.classList.add('hidden');
            if (groupDeepgram) groupDeepgram.classList.add('hidden');
            if (groupWhisperCpp) groupWhisperCpp.classList.add('hidden');
            if (groupWhisperModel) groupWhisperModel.classList.add('hidden');

            // Show selected
            if (provider === 'local') {
                if (groupLocal) groupLocal.classList.remove('hidden');
                if (groupWhisperModel) groupWhisperModel.classList.remove('hidden');
            } else if (provider === 'deepgram' && groupDeepgram) {
                groupDeepgram.classList.remove('hidden');
            } else if (provider === 'whispercpp') {
                if (groupWhisperCpp) groupWhisperCpp.classList.remove('hidden');
                if (groupWhisperModel) groupWhisperModel.classList.remove('hidden');
            }
        }
    </script>
    <script>
        // --- Unsaved Changes Guard ---
        let isFormDirty = false;

        function markDirty() {
            isFormDirty = true;
        }

        function setupDirtyCheck() {
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('change', markDirty);
                input.addEventListener('input', markDirty);
            });

            // Warn before leaving
            window.addEventListener('beforeunload', function (e) {
                if (isFormDirty) {
                    // Standard message (though most modern browsers show their own generic message)
                    const msg = "You have unsaved changes. Are you sure you want to leave?";
                    e.returnValue = msg;
                    return msg;
                }
            });

            // Clear dirty flag on valid submit
            const form = document.querySelector('form');
            if (form) {
                form.addEventListener('submit', function () {
                    isFormDirty = false;
                });
            }
        }

        // Initialize dirty check after DOM is ready
        document.addEventListener('DOMContentLoaded', setupDirtyCheck);
    </script>
</body>

</html>