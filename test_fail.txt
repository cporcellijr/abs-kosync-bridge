============================= test session starts =============================
platform win32 -- Python 3.13.7, pytest-9.0.2, pluggy-1.6.0 -- C:\Python313\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\cporc\docker-utils\stacks\abs-kosync-enhanced
plugins: anyio-4.11.0
collecting ... collected 8 items

tests/test_alignment_service.py::test_align_and_store_success FAILED     [ 12%]
tests/test_alignment_service.py::test_generate_alignment_map PASSED      [ 25%]
tests/test_alignment_service.py::test_get_time_for_text PASSED           [ 37%]
tests/test_polisher.py::test_normalize_basic PASSED                      [ 50%]
tests/test_polisher.py::test_normalize_roman PASSED                      [ 62%]
tests/test_polisher.py::test_clean_punctuation PASSED                    [ 75%]
tests/test_polisher.py::test_text_to_digits FAILED                       [ 87%]
tests/test_polisher.py::test_rebuild_fragmented_sentences FAILED         [100%]

================================== FAILURES ===================================
________________________ test_align_and_store_success _________________________

service = <src.services.alignment_service.AlignmentService object at 0x0000020450BC2900>
mock_db = <MagicMock id='2217557631600'>

    def test_align_and_store_success(service, mock_db):
        ebook_text = "This is a test sentence."
        segments = [
            {'start': 0.0, 'end': 1.0, 'text': "This is"},
            {'start': 1.0, 'end': 2.0, 'text': "a test sentence."}
        ]
    
        # Mocking behavior
        # We expect _save_alignment to be called
    
        result = service.align_and_store("test_id", segments, ebook_text)
    
>       assert result == True
E       assert False == True

tests\test_alignment_service.py:31: AssertionError
---------------------------- Captured stderr call -----------------------------
2026-02-05 19:57:39,843 - INFO - AlignmentService: Processing test_id (Text: 24 chars, Segments: 2)\n2026-02-05 19:57:39,844 - INFO -    Rebuilt segments: 2 -> 1\n2026-02-05 19:57:39,844 - ERROR -    \u274c Failed to generate alignment map.\n2026-02-05 19:57:39,844 - INFO - \u23f1\ufe0f [align_and_store] took 0ms
------------------------------ Captured log call ------------------------------
INFO     src.services.alignment_service:alignment_service.py:37 AlignmentService: Processing test_id (Text: 24 chars, Segments: 2)\nINFO     src.services.alignment_service:alignment_service.py:56    Rebuilt segments: 2 -> 1\nERROR    src.services.alignment_service:alignment_service.py:62    \u274c Failed to generate alignment map.\nINFO     src.utils.logging_utils:logging_utils.py:174 \u23f1\ufe0f [align_and_store] took 0ms
_____________________________ test_text_to_digits _____________________________

polisher = <src.utils.polisher.Polisher object at 0x0000020450C218C0>

    def test_text_to_digits(polisher):
        assert polisher.text_to_digits("one") == "1"
        assert polisher.text_to_digits("twenty one") == "21"
        assert polisher.text_to_digits("ninety nine") == "99"
>       assert polisher.text_to_digits("one hundred") == "one hundred" # Map only goes to 90 + 9 usually
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AssertionError: assert '1 hundred' == 'one hundred'
E         
E         - one hundred
E         ? ^^^
E         + 1 hundred
E         ? ^

tests\test_polisher.py:29: AssertionError
______________________ test_rebuild_fragmented_sentences ______________________

polisher = <src.utils.polisher.Polisher object at 0x0000020450C207C0>

    def test_rebuild_fragmented_sentences(polisher):
        ebook_text = "Mr. Smith went to Washington."
        segments = [
            {'start': 0.0, 'end': 1.0, 'text': "Mr."},
            {'start': 1.0, 'end': 2.0, 'text': "Smith"},
            {'start': 2.0, 'end': 3.0, 'text': "went to Washington."}
        ]
    
        rebuilt = polisher.rebuild_fragmented_sentences(segments, ebook_text)
    
        assert len(rebuilt) == 2
>       assert rebuilt[0]['text'] == "Mr. Smith"
E       AssertionError: assert 'Mr.' == 'Mr. Smith'
E         
E         - Mr. Smith
E         + Mr.

tests\test_polisher.py:42: AssertionError
============================== warnings summary ===============================
src\db\models.py:11
  C:\Users\cporc\docker-utils\stacks\abs-kosync-enhanced\src\db\models.py:11: MovedIn20Warning: The ``declarative_base()`` function is now available as sqlalchemy.orm.declarative_base(). (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    Base = declarative_base()

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/test_alignment_service.py::test_align_and_store_success - assert...
FAILED tests/test_polisher.py::test_text_to_digits - AssertionError: assert '...
FAILED tests/test_polisher.py::test_rebuild_fragmented_sentences - AssertionE...
=================== 3 failed, 5 passed, 1 warning in 0.65s ====================
