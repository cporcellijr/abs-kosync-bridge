<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Logs - ABS-KoSync Manager</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            min-height: 100vh;
            padding: 0;
        }

        /* Top Navigation Bar */
        .top-nav {
            background: linear-gradient(180deg, rgba(20, 20, 20, 0.98) 0%, rgba(20, 20, 20, 0.95) 100%);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            padding: 20px 40px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .logo-section a {
            text-decoration: none;
        }

        .logo-section h1 {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .library-links {
            display: flex;
            align-items: center;
            gap: 12px;
            padding-left: 20px;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-icon-link {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 38px;
            height: 38px;
            border-radius: 10px;
            color: rgba(255, 255, 255, 0.6);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.03);
            text-decoration: none;
        }

        .nav-icon-link:hover {
            color: #ffffff;
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .nav-icon-link svg {
            width: 20px;
            height: 20px;
            stroke-width: 2;
        }

        .nav-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        /* Main Content */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .page-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .page-header h1 {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .page-header p {
            font-size: 18px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* Controls */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-group label {
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
        }

        .control-group input,
        .control-group select {
            padding: 10px 14px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
            min-width: 120px;
        }

        .control-group input:focus,
        .control-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.3);
        }

        .search-input {
            min-width: 250px;
        }

        /* Log Stats */
        .log-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* Log Container */
        .log-container {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            overflow: hidden;
            height: 600px;
            display: flex;
            flex-direction: column;
        }

        .log-header {
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .log-content {
            flex: 1;
            overflow-y: auto;
            font-family: 'SF Mono', Consolas, 'Monaco', 'Liberation Mono', 'Lucida Console', monospace;
            font-size: 13px;
            line-height: 1.4;
        }

        .log-line {
            padding: 6px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.02);
            display: flex;
            align-items: flex-start;
            gap: 15px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .log-line:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .log-timestamp {
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
            min-width: 140px;
            font-weight: 500;
        }

        .log-level {
            min-width: 60px;
            font-weight: 700;
            font-size: 12px;
            text-align: center;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .log-level.DEBUG {
            background: rgba(108, 117, 125, 0.3);
            color: #adb5bd;
        }

        .log-level.INFO {
            background: rgba(23, 162, 184, 0.3);
            color: #17a2b8;
        }

        .log-level.WARNING {
            background: rgba(255, 193, 7, 0.3);
            color: #ffc107;
        }

        .log-level.ERROR {
            background: rgba(220, 53, 69, 0.3);
            color: #dc3545;
        }

        .log-level.CRITICAL {
            background: rgba(220, 53, 69, 0.5);
            color: #fff;
        }

        .log-message {
            flex: 1;
            color: #ffffff;
        }

        .log-module {
            color: rgba(255, 255, 255, 0.6);
            font-size: 11px;
            min-width: 80px;
            text-align: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 2px 6px;
            border-radius: 3px;
            margin-right: 10px;
        }

        /* Loading states */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
            color: rgba(255, 255, 255, 0.7);
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Auto refresh */
        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .auto-refresh input[type="checkbox"] {
            transform: scale(1.2);
        }

        /* Load More Button */
        .load-more {
            text-align: center;
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .container {
                padding: 20px 10px;
            }

            .controls {
                flex-direction: column;
                gap: 15px;
            }

            .log-line {
                flex-direction: column;
                gap: 5px;
                align-items: flex-start;
            }

            .log-timestamp,
            .log-level {
                min-width: auto;
            }

            .top-nav {
                padding: 15px 20px;
                flex-direction: column;
                gap: 15px;
            }

            .btn-sm {
                padding: 6px 12px !important;
                font-size: 12px !important;
            }

            .hidden {
                display: none !important;
            }
        }
    </style>
</head>

<body>
    <!-- Top Navigation -->
    <div class="top-nav">
        <div class="logo-section">
            <a href="/">
                <h1>üìö ABS-KoSync</h1>
            </a>

            <div class="library-links">
                {% if abs_server %}
                <a href="{{ abs_server }}" class="nav-icon-link" target="_blank" title="Audiobookshelf">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M11 5L6 9H2v6h4l5 4V5z"></path>
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                    </svg>
                </a>
                {% endif %}

                {% if booklore_server %}
                <a href="{{ booklore_server }}" class="nav-icon-link" target="_blank" title="Ebook Library">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                    </svg>
                </a>
                {% endif %}

                {% if shelfmark_url %}
                <a href="/shelfmark" class="nav-icon-link" title="Shelfmark Tool">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                        <line x1="7" y1="7" x2="7.01" y2="7"></line>
                    </svg>
                </a>
                {% endif %}
            </div>
        </div>

        <div class="nav-actions">
            <a href="/" class="btn btn-secondary">‚Üê Dashboard</a>
            <a href="/settings" class="btn btn-secondary">‚öôÔ∏è Settings</a>
            <a href="/book-linker" class="btn btn-secondary">üîó Book Linker</a>

            <a href="/match" class="btn btn-primary">‚ûï Add Book</a>
        </div>
    </div>

    <div class="container">
        <div class="page-header">
            <h1>Application Logs</h1>
            <p>View, filter, and monitor system logs in real-time</p>
        </div>

        <!-- Log Controls -->
        <div class="controls">
            <div class="control-group">
                <label for="logLevel">Min Log Level:</label>
                <select id="logLevel">
                    <option value="DEBUG">üîç DEBUG</option>
                    <option value="INFO" selected>‚ÑπÔ∏è INFO</option>
                    <option value="WARNING">‚ö†Ô∏è WARNING</option>
                    <option value="ERROR">‚ùå ERROR</option>
                    <option value="CRITICAL">üö® CRITICAL</option>
                </select>
            </div>

            <div class="control-group">
                <label for="searchInput">Filter by text:</label>
                <input type="text" id="searchInput" class="search-input" placeholder="Search logs...">
            </div>

            <div class="control-group">
                <label for="linesCount">Lines to show:</label>
                <select id="linesCount">
                    <option value="100">100</option>
                    <option value="500">500</option>
                    <option value="1000" selected>1000</option>
                    <option value="2500">2500</option>
                    <option value="5000">5000</option>
                </select>
            </div>

            <div class="control-group">
                <label>&nbsp;</label>
                <button id="refreshBtn" class="btn btn-primary">Refresh Logs</button>
            </div>

            <div class="control-group auto-refresh">
                <label for="autoRefresh">Auto-refresh (30s):</label>
                <input type="checkbox" id="autoRefresh">
            </div>

            <div class="control-group auto-refresh">
                <label for="liveMode">Live mode (real-time):</label>
                <input type="checkbox" id="liveMode">
            </div>
        </div>

        <!-- Log Stats -->
        <div class="log-stats">
            <span id="totalLinesStats">Total: 0 lines</span>
            <span id="displayedLinesStats">Showing: 0 lines</span>
            <span id="lastUpdated">Last updated: Never</span>
        </div>

        <!-- Log Container -->
        <div class="log-container">
            <div class="log-header">
                <h3>üìú Log Entries</h3>
                <div>
                    <button id="scrollToTop" class="btn btn-secondary btn-sm">‚¨ÜÔ∏è
                        Top</button>
                    <button id="scrollToBottom" class="btn btn-secondary btn-sm">‚¨áÔ∏è
                        Bottom</button>
                </div>
            </div>
            <div id="logContent" class="log-content">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading logs...
                </div>
            </div>
            <div id="loadMore" class="load-more hidden">
                <button class="btn btn-secondary">Load More Logs</button>
            </div>
        </div>
    </div>

    <script>
        let autoRefreshInterval = null;
        let liveRefreshInterval = null;
        let currentOffset = 0;
        let shownLogs = new Set(); // Track shown logs by timestamp+message

        // DOM elements
        const logContent = document.getElementById('logContent');
        const logLevel = document.getElementById('logLevel');
        const searchInput = document.getElementById('searchInput');
        const linesCount = document.getElementById('linesCount');
        const autoRefresh = document.getElementById('autoRefresh');
        const liveMode = document.getElementById('liveMode');
        const refreshBtn = document.getElementById('refreshBtn');
        const totalLinesStats = document.getElementById('totalLinesStats');
        const displayedLinesStats = document.getElementById('displayedLinesStats');
        const lastUpdated = document.getElementById('lastUpdated');
        const scrollToTop = document.getElementById('scrollToTop');
        const scrollToBottom = document.getElementById('scrollToBottom');
        const loadMore = document.getElementById('loadMore');

        // Track if user is at bottom for auto-scroll
        let isAtBottom = true;
        let userScrolled = false;

        // Monitor scroll position
        logContent.addEventListener('scroll', () => {
            const isCurrentlyAtBottom = logContent.scrollTop + logContent.clientHeight >= logContent.scrollHeight - 10;
            if (!isCurrentlyAtBottom && !userScrolled) {
                userScrolled = true;
            }
            isAtBottom = isCurrentlyAtBottom;
        });

        // Fetch logs from API
        async function fetchLogs(offset = 0, append = false) {
            try {
                const params = new URLSearchParams({
                    level: logLevel.value,
                    search: searchInput.value,
                    lines: linesCount.value,
                    offset: offset
                });

                const response = await fetch(`/api/logs?${params}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to fetch logs');
                }

                displayLogs(data, append);
                updateStats(data);
                updateLastUpdated();

                return data;
            } catch (error) {
                console.error('Error fetching logs:', error);
                logContent.innerHTML = `
                    <div class="log-line">
                        <span class="log-level ERROR">ERROR</span>
                        <span class="log-message">Failed to fetch logs: ${error.message}</span>
                    </div>
                `;
            }
        }

        // Fetch live logs from memory
        async function fetchLiveLogs() {
            try {
                const params = new URLSearchParams({
                    level: logLevel.value,
                    search: searchInput.value,
                    count: 50
                });

                const response = await fetch(`/api/logs/live?${params}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to fetch live logs');
                }

                if (data.logs && data.logs.length > 0) {
                    // For filter changes, force show all matching logs
                    const forceShow = logContent.innerHTML.includes('Switching filter') || logContent.innerHTML.includes('Applying filter');
                    appendNewLogs(data.logs, forceShow);
                    updateLastUpdated();
                } else if (logContent.innerHTML.includes('Switching filter') || logContent.innerHTML.includes('Applying filter')) {
                    // No logs found with current filters
                    logContent.innerHTML = `
                        <div class="log-line">
                            <span class="log-level INFO">INFO</span>
                            <span class="log-message">No logs found matching current filters</span>
                        </div>
                    `;
                }

                return data;
            } catch (error) {
                console.error('Error fetching live logs:', error);
            }
        }

        // Append new logs to existing content
        function appendNewLogs(logs, forceShow = false) {
            if (!logs || logs.length === 0) {
                // If no logs and we're in a loading state, show no logs message
                if (logContent.innerHTML.includes('Switching filter') || logContent.innerHTML.includes('Applying filter')) {
                    logContent.innerHTML = `
                        <div class="log-line">
                            <span class="log-level INFO">INFO</span>
                            <span class="log-message">No logs found matching current filters</span>
                        </div>
                    `;
                }
                return;
            }

            const scrollToBottomAfter = isAtBottom;

            // Clear loading message and reset tracking if present
            if (logContent.innerHTML.includes('Switching filter') || logContent.innerHTML.includes('Applying filter')) {
                logContent.innerHTML = '';
                shownLogs.clear(); // Clear tracking when filters change
                forceShow = true; // Show all logs when clearing filter
            }

            logs.forEach(log => {
                // Create unique identifier for this log
                const logId = `${log.timestamp}|${log.message}`;

                // Check if we've already shown this exact log, or if we're forcing show (filter change)
                if (forceShow || !shownLogs.has(logId)) {
                    const logLine = document.createElement('div');
                    logLine.className = 'log-line';

                    logLine.innerHTML = `
                        <span class="log-timestamp">${escapeHtml(log.timestamp)}</span>
                        <span class="log-level ${log.level}">${log.level}</span>
                        <span class="log-module">${escapeHtml(log.module || 'unknown')}</span>
                        <span class="log-message">${escapeHtml(log.message)}</span>
                    `;

                    // Add visual indicator for new logs (only if not forcing show)
                    if (!forceShow) {
                        logLine.style.background = 'rgba(102, 126, 234, 0.1)';
                        setTimeout(() => {
                            logLine.style.background = '';
                        }, 2000);
                    }

                    logContent.appendChild(logLine);

                    // Mark this log as shown
                    shownLogs.add(logId);
                }
            });

            // Auto-scroll to bottom if user was already at bottom
            if (scrollToBottomAfter) {
                setTimeout(() => {
                    logContent.scrollTop = logContent.scrollHeight;
                }, 10);
            }

            // Update stats
            const currentLines = logContent.children.length;
            displayedLinesStats.textContent = `Showing: ${currentLines} lines (live mode)`;
        }

        // Display logs in the container
        function displayLogs(data, append = false) {
            const logs = data.logs || [];

            if (!append) {
                logContent.innerHTML = '';
                currentOffset = 0;
                shownLogs.clear(); // Clear shown logs tracking
                userScrolled = false;
                isAtBottom = true;
            }

            if (logs.length === 0) {
                if (!append) {
                    logContent.innerHTML = `
                        <div class="log-line">
                            <span class="log-level INFO">INFO</span>
                            <span class="log-message">No logs found matching current filters</span>
                        </div>
                    `;
                }
                return;
            }

            logs.forEach(log => {
                const logLine = document.createElement('div');
                logLine.className = 'log-line';

                logLine.innerHTML = `
                    <span class="log-timestamp">${escapeHtml(log.timestamp)}</span>
                    <span class="log-level ${log.level}">${log.level}</span>
                    <span class="log-module" style="color: rgba(255,255,255,0.6); font-size: 11px; min-width: 80px;">${escapeHtml(log.module || 'unknown')}</span>
                    <span class="log-message">${escapeHtml(log.message)}</span>
                `;

                logContent.appendChild(logLine);

                // Track this log as shown
                const logId = `${log.timestamp}|${log.message}`;
                shownLogs.add(logId);
            });

            // Show/hide load more button (not available in live mode)
            if (liveMode.checked) {
                loadMore.style.display = 'none';
            } else if (data.has_more) {
                loadMore.style.display = 'block';
                currentOffset = data.displayed_lines;
            } else {
                loadMore.style.display = 'none';
            }

            // Auto-scroll to bottom for initial load
            if (!append) {
                setTimeout(() => {
                    logContent.scrollTop = logContent.scrollHeight;
                }, 10);
            }
        }

        // Update statistics display
        function updateStats(data) {
            if (data.total_lines !== undefined) {
                totalLinesStats.textContent = `Total: ${data.total_lines || 0} lines`;
            }
            if (data.displayed_lines !== undefined) {
                displayedLinesStats.textContent = `Showing: ${data.displayed_lines || 0} lines`;
            }
        }

        // Update last updated timestamp
        function updateLastUpdated() {
            const now = new Date();
            lastUpdated.textContent = `Last updated: ${now.toLocaleTimeString()}`;
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Debounce function for search input
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Toggle live mode
        function toggleLiveMode() {
            if (liveMode.checked) {
                // Start live mode
                displayedLinesStats.textContent = `Showing: ${logContent.children.length} lines (live mode)`;
                liveRefreshInterval = setInterval(fetchLiveLogs, 2000); // Poll every 2 seconds
                loadMore.style.display = 'none';

                // Disable auto-refresh when live mode is on
                if (autoRefresh.checked) {
                    autoRefresh.checked = false;
                    if (autoRefreshInterval) {
                        clearInterval(autoRefreshInterval);
                        autoRefreshInterval = null;
                    }
                }
            } else {
                // Stop live mode
                if (liveRefreshInterval) {
                    clearInterval(liveRefreshInterval);
                    liveRefreshInterval = null;
                }
                // Reload full logs
                fetchLogs();
            }
        }

        // Event listeners
        refreshBtn.addEventListener('click', () => {
            if (liveMode.checked) {
                fetchLiveLogs();
            } else {
                fetchLogs();
            }
        });

        logLevel.addEventListener('change', () => {
            if (liveMode.checked) {
                // In live mode, clear content and reset timestamp tracking for filter changes
                logContent.innerHTML = '<div class="loading"><div class="spinner"></div>Switching filter...</div>';
                lastLogTimestamp = null; // Reset timestamp so all matching logs will be shown
                setTimeout(() => {
                    fetchLiveLogs().then(() => {
                        // Ensure we show all matching logs by treating this as a forced refresh
                        if (logContent.innerHTML.includes('Switching filter')) {
                            // If still showing loading, it means no logs matched
                            logContent.innerHTML = `
                                <div class="log-line">
                                    <span class="log-level INFO">INFO</span>
                                    <span class="log-message">No logs found matching current filters</span>
                                </div>
                            `;
                        }
                    });
                }, 500);
            } else {
                fetchLogs();
            }
        });

        linesCount.addEventListener('change', () => {
            if (!liveMode.checked) {
                fetchLogs();
            }
        });

        searchInput.addEventListener('input', debounce(() => {
            if (liveMode.checked) {
                // In live mode, clear content and reset timestamp tracking for filter changes
                logContent.innerHTML = '<div class="loading"><div class="spinner"></div>Applying filter...</div>';
                lastLogTimestamp = null; // Reset timestamp so all matching logs will be shown
                setTimeout(() => {
                    fetchLiveLogs().then(() => {
                        // Ensure we show all matching logs by treating this as a forced refresh
                        if (logContent.innerHTML.includes('Applying filter')) {
                            // If still showing loading, it means no logs matched
                            logContent.innerHTML = `
                                <div class="log-line">
                                    <span class="log-level INFO">INFO</span>
                                    <span class="log-message">No logs found matching current filters</span>
                                </div>
                            `;
                        }
                    });
                }, 500);
            } else {
                fetchLogs();
            }
        }, 500));

        autoRefresh.addEventListener('change', (e) => {
            if (e.target.checked) {
                // Disable live mode if auto-refresh is enabled
                if (liveMode.checked) {
                    liveMode.checked = false;
                    toggleLiveMode();
                }
                autoRefreshInterval = setInterval(() => fetchLogs(), 30000);
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        });

        liveMode.addEventListener('change', toggleLiveMode);

        scrollToTop.addEventListener('click', () => {
            logContent.scrollTop = 0;
            userScrolled = true;
            isAtBottom = false;
        });

        scrollToBottom.addEventListener('click', () => {
            logContent.scrollTop = logContent.scrollHeight;
            userScrolled = false;
            isAtBottom = true;
        });

        loadMore.addEventListener('click', async () => {
            if (!liveMode.checked) {
                const data = await fetchLogs(currentOffset, true);
                if (data) {
                    currentOffset += data.displayed_lines;
                }
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 'r':
                        e.preventDefault();
                        if (liveMode.checked) {
                            fetchLiveLogs();
                        } else {
                            fetchLogs();
                        }
                        break;
                    case 'f':
                        e.preventDefault();
                        searchInput.focus();
                        break;
                    case 'l':
                        e.preventDefault();
                        liveMode.checked = !liveMode.checked;
                        toggleLiveMode();
                        break;
                }
            }
        });

        // Initial load
        // Ensure form elements reflect correct initial state (prevent browser caching issues)
        logLevel.value = 'INFO';
        liveMode.checked = true;
        autoRefresh.checked = false;
        linesCount.value = '1000';
        searchInput.value = '';

        if (liveMode.checked) {
            fetchLiveLogs();
        } else {
            fetchLogs();
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            if (liveRefreshInterval) {
                clearInterval(liveRefreshInterval);
            }
        });
    </script>
</body>

</html>