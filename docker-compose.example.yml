# ABS-KoSync Enhanced - Example Docker Compose Configuration
#
# Copy this file to docker-compose.yml and fill in your values.
# See README.md for detailed configuration instructions.

services:
  abs-kosync-enhanced:
    build: .
    # Or use pre-built image:
    # image: your-username/abs-kosync-enhanced:latest
    container_name: abs_kosync_enhanced
    restart: unless-stopped

    environment:
      # ============================================
      # General Settings
      # ============================================
      - TZ=America/New_York
      - LOG_LEVEL=INFO

      # ============================================
      # Audiobookshelf Configuration (REQUIRED)
      # ============================================
      # Your ABS server URL
      - ABS_SERVER=https://your-audiobookshelf-server.com
      # API key from ABS: Settings -> Users -> Your User -> API Token
      - ABS_KEY=your_abs_api_key_here
      # Library ID from URL: /library/THIS_PART_HERE
      - ABS_LIBRARY_ID=your_library_id
      # Collection name for synced books (auto-created if missing)
      - ABS_COLLECTION_NAME=Synced with KOReader
      # Optionally, adjust progress offset in seconds, like -60 for 1 minute back
      # - ABS_PROGRESS_OFFSET_SECONDS=-60

      # ============================================
      # KOSync Configuration (REQUIRED)
      # ============================================
      # Your KOSync server (Calibre with KOSync plugin, or standalone)
      - KOSYNC_SERVER=https://your-calibre-server.com/api/koreader
      - KOSYNC_USER=your_username
      - KOSYNC_KEY=your_password
      # Hash method: 'content' (recommended) or 'filename'
      - KOSYNC_HASH_METHOD=content
      # Whether to use percentage progress from KOSync server instead of calculating from text matching when saving the previous state
      - KOSYNC_USE_PERCENTAGE_FROM_SERVER=false

      # ============================================
      # Hardcover Integration (OPTIONAL)
      # ============================================
      # Get your token from: https://hardcover.app/account/api
      # Leave empty or remove to disable Hardcover sync
      - HARDCOVER_TOKEN=your_hardcover_api_token_here

      # ============================================
      # Storyteller Integration (OPTIONAL)
      # ============================================
      # Option 1: REST API (Recommended - prevents mobile app overwrites)
      # Use host.docker.internal to reach host machine from container
      - STORYTELLER_API_URL=http://host.docker.internal:8001
      - STORYTELLER_USER=your_storyteller_username
      - STORYTELLER_PASSWORD=your_storyteller_password

      # Option 2: Direct SQLite (Legacy - may be overwritten by mobile app)
      # Only used as fallback if API credentials not set
      - STORYTELLER_DB_PATH=/storyteller_data/storyteller.db

      # ============================================
      # Booklore Integration (OPTIONAL)
      # ============================================
      # Auto-add synced books to a Booklore shelf
      - BOOKLORE_SERVER=https://your-calibre-server.com
      - BOOKLORE_USER=your_username
      - BOOKLORE_PASSWORD=your_password
      - BOOKLORE_SHELF_NAME=Kobo

      # ============================================
      # Sync Behavior Settings
      # ============================================
      # How often to check for progress changes (minutes)
      - SYNC_PERIOD_MINS=5
      # Minimum audiobook progress change to trigger sync (seconds)
      - SYNC_DELTA_ABS_SECONDS=60
      # Minimum ebook progress change to trigger sync (percentage, 0-100)
      - SYNC_DELTA_KOSYNC_PERCENT=0.5
      # Minimum word count change to trigger sync
      - SYNC_DELTA_KOSYNC_WORDS=400
      # Fuzzy text matching threshold (0-100, higher = stricter)
      - FUZZY_MATCH_THRESHOLD=88

      # ============================================
      # Book Linker Settings (OPTIONAL)
      # ============================================
      # For Storyteller automated processing workflow
      - MONITOR_INTERVAL=3600
      - LINKER_BOOKS_DIR=/linker_books
      - PROCESSING_DIR=/processing
      - AUDIOBOOKS_DIR=/audiobooks
      - STORYTELLER_INGEST_DIR=/storyteller/library

      # ============================================
      # Telegram Logging Integration (OPTIONAL)
      # ============================================
      # Enable Telegram log forwarding for errors and above.
      # Get your bot token from @BotFather and chat ID from @userinfobot or via API.
      # Uncomment and fill in the following lines to enable:
      # - TELEGRAM_BOT_TOKEN=123456789:ABCdefGHIjklMNOpqrSTUvwxYZ
      # - TELEGRAM_CHAT_ID=123456789
      # - TELEGRAM_LOG_LEVEL=ERROR  # Options: DEBUG, INFO, WARNING, ERROR, CRITICAL

    volumes:
      # ============================================
      # REQUIRED VOLUMES
      # ============================================
      # App data (database, transcripts, state)
      - ./data:/data

      # Main ebook library (for sync matching)
      - /path/to/your/ebooks:/books

      # ============================================
      # OPTIONAL VOLUMES
      # ============================================
      # Storyteller database (for SQLite fallback)
      - /path/to/storyteller/data:/storyteller_data

      # Book Linker volumes
      - /path/to/source/ebooks:/linker_books
      - /path/to/audiobooks:/audiobooks
      - /path/to/processing/folder:/processing
      - /path/to/storyteller/library:/storyteller/library

    ports:
      - "8080:5757"

    networks:
      - your-network

networks:
  your-network:
    external: true